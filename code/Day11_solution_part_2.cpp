#include <array>
#include <exception>
#include <fstream>
#include <iostream>
#include <limits>
#include <map>
#include <memory>
#include <numeric>
#include <sstream>
#include <string>
#include <string_view>
#include <unordered_set>

namespace{

constexpr std::string_view Input =

false ?

"...#......\n"
".......#..\n"
"#.........\n"
"..........\n"
"......#...\n"
".#........\n"
".........#\n"
"..........\n"
".......#..\n"
"#...#.....\n"

:

"..............................#.............#.....#.............#...........#......................................#...............#........\n"
"....................#.........................................................................#.........#...................................\n"
"...........#............................#...............................................#...................................................\n"
"......................................................................#...........................#.........................................\n"
".#.......................................................#.....................................................#.............#..............\n"
"......................#.............#..............................................#.......#..........#.....................................\n"
"............................................................................................................................................\n"
"................#..........#................#................#................#........#..................................#.................\n"
"...................................................#........................................................#......................#........\n"
"............................................................................................................................................\n"
".....#............................................................#.........................................................................\n"
"................................#.......................................#........#.............#........#.....................#.............\n"
"...........................................#.......................................................................#........................\n"
"..........#...........................................................................................................................#.....\n"
".#.................................................#.....................................................................#..................\n"
"............................#......#.........................................#..............#................#..............................\n"
"..............#..........................................#........#...............................#.........................................\n"
"...................#.......................................................................................................................#\n"
".........#..................................................................................................................................\n"
"..........................................................................................................#................#................\n"
"..#..........................................#.................................#.......#......#.......................#.....................\n"
"..................................................#.........................................................................................\n"
".......#................#................................................#..................................................................\n"
".............................#...........#...................#......................#............#...............................#.........#\n"
".............#......................................................................................................#.......................\n"
"..............................................#................................................................#............................\n"
".....................................#............................#..........#...........................#.................#................\n"
".....................#......................................................................................................................\n"
"#.........................................#.......................................................#...............................#.........\n"
"......................................................................#.....................................................................\n"
"...................................#..................#........#....................#............................#..........................\n"
"...................#............................#...........................................................................................\n"
"...................................................................#....................#.....................................#........#....\n"
".........#...............................#.....................................#.......................................#....................\n"
".#..........................................................................................................................................\n"
"............................................................................................#......................#.......................#\n"
"................#..............#.............................#.......................#............#................................#........\n"
".....................#............................#...............#.........................................................................\n"
"........................................................#.......................#.........................................#.................\n"
"...........................#..........................................#...............................#.....................................\n"
".....................................#.....................................................................#................................\n"
"...........#.......#.............................................................................................................#.......#..\n"
".....#........................#..................#..................................................................#.......................\n"
"...........................................#................................#...............................................................\n"
"..............................................................#.............................................................................\n"
"........................................................#............#...............#......................#...............................\n"
".#..........................................................................................................................................\n"
"....................#...........#.......................................................................................#...................\n"
"......................................#..............#...........#.................................................#...................#....\n"
".......#.....#..........#....................................................................#.................................#............\n"
".............................#..............#...............................................................................................\n"
"............................................................................................................................................\n"
"#............................................................#.....................................#.....................................#..\n"
"....................#..................................#...........................#.....................#..................................\n"
"............................................................................................................................................\n"
"............#..........................................................#.............................................................#......\n"
"............................#...................................#.............#.................#.............#......#......#...............\n"
"..................#...........................#.............................................................................................\n"
".......................#...........#.................................................#............................................#.........\n"
"............................................................................................................................................\n"
"..............................#.........#.................................#............................................................#....\n"
"............................................................................................................................................\n"
"....#.................................................................#...................................#..............#..................\n"
"...........#..................................................#...................................#.............#...........................\n"
"................#...........................#...............................................................................................\n"
".#.....................#...............................#...........#...........#.....#.............................................#........\n"
"............................................................................................................................................\n"
"........#........................#.....................................#...............................................#....................\n"
"............................................................................................................................................\n"
"................................................................................................................#...........................\n"
"............................................................................................................................................\n"
"......................................#..............#.........#...........#...........#...............#....................................\n"
"...........#.......................................................................................................#.................#......\n"
"......#.....................................#.......................#......................#..............................................#.\n"
"..............................................................................#..............................................#..............\n"
"...............................#...........................#................................................#...............................\n"
"................................................#...................................................#............#...............#..........\n"
"............#............................#................................#.............#................................#..................\n"
".................#.......#..................................................................................................................\n"
"....................................#.................................#..............................................#...............#......\n"
".........#..................................................................................................................................\n"
".............................#.................................................................................#............................\n"
"......................#...................#..................................................#.........#....................................\n"
"............................................................................................................................................\n"
"#..................................................#........................................................................................\n"
"........#.......................................................................#.................................#.......#.................\n"
".............#.........................................#............#..............................................................#........\n"
".....................................#........................#......................#............#.........................................\n"
".........................#.......................#..........................#...........................#......................#............\n"
".................................#.........#................................................................................................\n"
"...................#.........................................................................#..........................#...................\n"
"............................................................................................................................................\n"
"..............................#....................#............#.........................................................................#.\n"
".........................................................................................................#.......#.........#................\n"
"..........#.......................................................................................................................#.........\n"
"....#.............#.......#.........................................#............#..........................................................\n"
"...................................#........................................................................................................\n"
"...........................................................#............................................................#...................\n"
"#..............................#.............#.....#.........................#.......#...............#........................#.....#.......\n"
"................................................................................................#........................................#..\n"
"........#...............#................................................................#...........................#......................\n"
"...................#.....................................#.......................#.........................................#................\n"
"............................................................................................................................................\n"
"..............#..................................................#...........................#...................#..........................\n"
"...............................#..............#...........................#.................................................................\n"
"#..........................................................#........................#..........................................#.......#....\n"
".....................................................#....................................................#.........#.......................\n"
"..........................#................................................................#......#.......................#.................\n"
"....#.....#.....................................................................................................#...........................\n"
".....................#.....................#..........................................#.....................................................\n"
".........................................................................#..............................................................#...\n"
"..............#......................................................................................#........................#.............\n"
"...........................#..........#............#...............................................................#........................\n"
"........#....................................#..............................................................................................\n"
".................................................................#..........................#....................................#..........\n"
".................................................................................#.....................#.....#...........................#..\n"
"............................................................................................................................................\n"
"..........................#.................................................................................................................\n"
"..............................................................................#.............................................................\n"
".........................................................................#...................#......................................#.......\n"
"...#.........#......#................................#..................................................................#...................\n"
"...............................#.............#...............#.......................#...........................#..........................\n"
".......................................................................................................#.........................#..........\n"
"............................................................................#...............................................................\n"
".#....................#.............................................#....................................................................#..\n"
"....................................#..................#....................................................................................\n"
".....#........................#...............#..........................#...................................#..............................\n"
"...........#........................................................................................#.......................................\n"
"................#.........#................................#.....#..............................................................#...........\n"
"......................................#..............................................#.................................................#....\n"
".................................................................................................#......#........#.....#....................\n"
"#......................#.............................................#......................................................................\n"
"..............#..........................#..............#...................................................................................\n"
"...........................................................................#................................................................\n"
"..................#..............#.................#..............#...........................................#.....................#.......\n"
"............................................................................................#...............................................\n"
"..........................#.............................................#........#........................#.................................\n"
"..........#...........................................#.....................................................................................\n"
"......................................#........................#...............................#...........................................#\n"
".....#........#..............#.......................................#.............................................#..........#.............\n"
;

using Coord = size_t;

struct Point{
    Coord x;
    Coord y;
};
bool operator==(const Point p1, const Point p2){
    return (p1.x == p2.x) && (p1.y == p2.y);
}
/*bool operator!=(const Point p1, const Point p2){
    return !(p1 == p2);
}*/

} // namespace

auto day11Part2(std::string_view streamSource, bool sourceIsFilePath)
{
    std::shared_ptr<std::istream> inputStream;

    if (sourceIsFilePath) {
        inputStream = std::static_pointer_cast<std::istream>(
            std::make_shared<std::ifstream>(std::string(streamSource)));
    } else {
        auto sstream = std::make_shared<std::stringstream>();
        (*sstream) << streamSource;
        // use std::move(sstream) in C++20 or more.
        inputStream = std::static_pointer_cast<std::istream>(sstream);
    }

    size_t rowsLength = 0U;

    constexpr size_t SeedHash = 10000U;
    static constexpr auto HashPoints = [](const Point p) { return p.x + (SeedHash * p.y); };

    std::unordered_set<Point, decltype(HashPoints)> galaxies(0U, HashPoints);
    std::unordered_set<Coord> nonEmptyRows(0U);
    std::unordered_set<Coord> nonEmptyCols(0U);

    const auto pointToStr = [](Point p) {
        using std::literals::string_literals::operator""s;
        return "("s + std::to_string(p.x) + ", " + std::to_string(p.y) + ')';
    };

    unsigned lineCount{0U};

    constexpr auto MaxLineLength = 1000;
    std::array<char, MaxLineLength + 1> cc{};
    while (inputStream->getline(cc.data(), MaxLineLength, '\n')) {
        ++lineCount;
        std::string errorLine = "Input error at the line n. "
            + std::to_string(static_cast<int>(lineCount)) + " : ";

        auto c = static_cast<size_t>(inputStream->gcount());
        // 'c' includes the delimiter, which is replaced by '\0'.
        if (c > MaxLineLength) {
            throw std::invalid_argument(
                errorLine + "longer than " + std::to_string(MaxLineLength));
        }

        std::string line;
        // std::cout << "length = " << c << '\n';
        if (cc.at(c - 1U) == '\0') { // 'c' is positive as line has been extracted.
            --c; // excludes '\0' that replaced the delimiter '\n'.
        }
        line = std::string_view(cc.data(), c);
        // std::cout << "line: " << line << '\n';

        // std::stringstream lineStream;
        // lineStream << line;

        if constexpr (sizeof(Coord) < sizeof(decltype(line.length()))) {
            // TODO, likely... just define Coord as size_t to be sure.
            if (line.length() > std::numeric_limits<Coord>::max()) {
                throw std::invalid_argument(errorLine + "Too long line");
            }
        }

        if (lineCount == 1U) {
            rowsLength = line.length();
        } else if (line.length() != rowsLength) {
            throw std::invalid_argument(errorLine + "line length different from previous ones");
        }

        Coord y = lineCount;
        bool emptyRow = true;
        for (Coord x = 1U; x <= line.length(); ++x) {
            const auto ch = line[x - 1U];
            if (ch == '#') {
                galaxies.insert(Point{x, y});

                nonEmptyCols.insert(x);
                emptyRow = false;
            }
        }

        if (!emptyRow) {
            nonEmptyRows.insert(y);
        }
    }

    if (lineCount > SeedHash) {
        std::cout << "WARNING: better to generalize code\n";
        // but still works.
    }

    using Dist = Coord; // no more than 4*Coord

    unsigned additions = 0U;

    const auto manDist
        = [&nonEmptyRows, nonEmptyCols, &additions](const Point g1, const Point g2) {
                // double expanded parts

                const auto mx = std::min(g1.x, g2.x);
                // NOLINTNEXTLINE(readability-identifier-naming)
                const auto Mx = std::max(g1.x, g2.x); // prefer uppercase.

                const auto my = std::min(g1.y, g2.y);
                // NOLINTNEXTLINE(readability-identifier-naming)
                const auto My = std::max(g1.y, g2.y); // prefer uppercase.

                auto res = (Mx - mx) + (My - my);

                for (auto i = mx; i <= Mx; ++i) {
                    if (nonEmptyCols.count(i) == 0U) {
                        ++additions;
                    }
                }

                for (auto j = my; j <= My; ++j) {
                    if (nonEmptyRows.count(j) == 0U) {
                        ++additions;
                    }
                }

                return res;
            };

    Dist sumDist = 0U;

    for (const auto g1 : galaxies) {
        for (const auto g2 : galaxies) {
            auto manatDist = manDist(g1, g2);

            constexpr auto GalaxyThresholdToPrint = 10U;
            if (galaxies.size() <= GalaxyThresholdToPrint) {
                // TODO: avoid printing twice, by using a vector. Then, just half the
                // computation time exploiting it.
                std::cout << "Dist between " << pointToStr(g1) << " to " << pointToStr(g2)
                            << " is " << manatDist << '\n';
            }

            sumDist += manatDist;
        }
    }

    std::cout << "Line count " << lineCount << std::endl;
    std::cout << "Galaxy count " << galaxies.size() << std::endl;

    sumDist /= 2;
    additions /= 2;

    std::cout << "Total additions " << additions << std::endl;
    std::cout << "Sum dist before expansion " << sumDist << std::endl;

    constexpr size_t Expansion = 1000000UL;
    sumDist += ((Expansion - 1UL) * additions);

    std::cout << "\nResult Day 11 p.2 : " << sumDist << std::endl;

    return sumDist;
}

int main11p2()
{
    try {
        day11Part2(Input, false);
        // day11Part2("./1_input_file.txt",true);
    } catch (std::invalid_argument& ex) {
        std::cout << std::endl; // in order to flash
        std::cerr << "Bad input: " << ex.what() << std::endl;
        return 1;
    } catch (std::exception& ex) {
        std::cout << std::endl; // in order to flash
        std::cerr << "Error: " << ex.what() << std::endl;
        return 1;
    } catch (...) {
        std::cout << std::endl; // in order to flash
        std::cerr << "Unknown error: " << std::endl;
        return 1;
    }

    return 0;
}


/*
OUTPUT:

Example with 10:
Line count 10
Galaxy count 9
Total additions 82
Sum dist before expansion 292
Result: 1030

Example with 100:
Line count 10
Galaxy count 9
Total additions 82
Sum dist before expansion 292
Result: 8410

Real input:
Line count 140
Galaxy count 429
Total additions 842638
Sum dist before expansion 8756432
Result: 842645913794
*/
